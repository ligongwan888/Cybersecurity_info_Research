<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åæ³°ç½‘ç»œå®‰å…¨å®¢æˆ·ä¿¡æ¯æŸ¥è¯¢</title>
    <style>
        /* --- å®šä¹‰æ–°çš„ä¸»é¢˜è‰² --- */
        :root {
            --main-color: #00BFFF; /* æ·±å¤©è“è‰² - ç°ä»£ã€ç§‘æŠ€æ„Ÿ */
            --light-color: #87CEEB; /* æµ…è“è‰² */
            --dark-bg: rgba(0, 0, 0, 0.7); 
            --darkest-bg: #000;
            --border-radius: 8px; /* æ–°å¢ï¼šåœ†è§’åŠå¾„ */
        }

        /* --- 1. å…¨å±€æ ·å¼å’Œæ•°å­—é›¨èƒŒæ™¯ (æ”¹ä¸ºè“è‰²) --- */
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden; 
            background: var(--darkest-bg);
            font-family: 'Consolas', monospace; 
            color: var(--light-color);
        }
        canvas {
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1; 
        }
        /* --- 2. å®¹å™¨æ ·å¼ --- */
        #content-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10; 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center; 
            text-shadow: 0 0 5px var(--main-color);
        }
        h1 {
            /* æ ‡é¢˜å·²åˆ é™¤ */
            display: none; 
            color: var(--main-color);
            font-size: 2.5em;
            margin-bottom: 30px;
            text-shadow: 0 0 10px var(--main-color), 0 0 20px var(--main-color); 
        }
        /* --- 3. è¾“å…¥å’Œæœç´¢æ¡†æ ·å¼ --- */
        #search-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 80%;
            max-width: 600px;
            padding: 20px;
            background: var(--dark-bg); 
            border: 1px solid var(--main-color);
            box-shadow: 0 0 10px var(--main-color);
            border-radius: var(--border-radius); /* åœ†è§’åŒ– */
            margin-bottom: 20px;
        }
        #name-input-group, #url-input-group, #file-upload-group {
            display: flex;
            width: 100%;
            margin-bottom: 15px;
        }
        input[type="text"], button, input[type="file"] {
            padding: 10px;
            border: 1px solid var(--main-color);
            font-size: 1em;
            background: rgba(0, 0, 0, 0.9);
            color: var(--light-color);
            font-family: 'Consolas', monospace;
            box-shadow: inset 0 0 5px var(--main-color);
            border-radius: var(--border-radius); /* åœ†è§’åŒ– */
        }
        input[type="text"] {
            flex-grow: 1;
            margin-right: 10px;
        }
        button {
            cursor: pointer;
            transition: background-color 0.3s, color 0.3s;
        }
        button:hover {
            background-color: var(--main-color);
            color: #000;
        }
        /* --- 4. ç»“æœå’Œä¿¡æ¯æ ·å¼ --- */
        #results-container {
            width: 80%;
            max-width: 600px;
            padding: 20px;
            background: var(--dark-bg);
            border: 1px solid var(--main-color);
            box-shadow: 0 0 10px var(--main-color);
            border-radius: var(--border-radius); /* åœ†è§’åŒ– */
            text-align: left;
        }
        .info-item {
            margin-bottom: 10px; 
            padding: 10px; 
            border-bottom: 1px dotted var(--light-color);
            word-wrap: break-word; 
            white-space: normal;  
        }
        .label { 
            font-weight: bold; 
            color: var(--main-color); /* æ ‡é¢˜ä½¿ç”¨ä¸»è‰² */
            display: inline-block; 
            width: 120px; 
            vertical-align: top;
        }
        .content {
            color: #FFF; /* å†…å®¹ä½¿ç”¨ç™½è‰² */
        }
        a {
            color: var(--light-color); /* é“¾æ¥ä½¿ç”¨æµ…è‰² */
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }
        #loading {
            color: #FFD700; 
            font-weight: bold;
            margin-top: 15px;
        }
        /* --- 5. è¿›åº¦æ¡æ ·å¼ --- */
        #progress-bar {
            width: 0;
            height: 5px;
            background-color: var(--main-color);
            box-shadow: 0 0 5px var(--main-color);
            transition: width 0.1s linear; 
            margin-top: 10px;
            border-radius: 2px;
        }
        #progress-container {
            width: 100%;
            max-width: 600px;
            background: rgba(50, 50, 50, 0.5);
            border-radius: 2px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    
    <div id="content-container">
        <div id="search-box">
            <div id="name-input-group">
                <input type="text" id="companyName" placeholder="ğŸ” è¯·è¾“å…¥å®¢æˆ·å…¬å¸åç§°" required>
                <button onclick="searchCompany()">æœç´¢</button>
            </div>

            <div id="url-input-group">
                <input type="text" id="companyUrl" placeholder="è¾“å…¥ç½‘å€å‡†ç¡®æ€§æ›´é«˜ (å¯é€‰)" onfocus="this.placeholder=''" onblur="this.placeholder='è¾“å…¥ç½‘å€å‡†ç¡®æ€§æ›´é«˜ (å¯é€‰)'">
            </div>

            <div id="file-upload-group">
                <input type="file" id="fileInput" accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.png" style="width: 100%;">
            </div>
        </div>

        <div id="loading" style="display:none;">æ­£åœ¨è¿›è¡Œæ·±åº¦å®‰å…¨ä¿¡æ¯æ£€ç´¢...</div>

        <div id="progress-container" style="display:none;">
            <div id="progress-bar"></div>
        </div>

        <div id="results-container">
            <div id="results">
                </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        // è®¾ç½® Canvas å¤§å°
        let W = canvas.width = window.innerWidth;
        let H = canvas.height = window.innerHeight;

        // çŸ©é˜µé›¨æ ¸å¿ƒé€»è¾‘
        let font_size = 12;
        let columns = Math.floor(W / font_size);
        let drops = [];
        for(let x=0; x<columns; x++) drops[x] = 1;

        const characters = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ!@#$%^&*()';

        function draw() {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
            ctx.fillRect(0, 0, W, H);
            
            ctx.fillStyle = '#00BFFF'; // ä½¿ç”¨ä¸»é¢œè‰²
            ctx.font = font_size + 'px Consolas';

            for(let i=0; i<drops.length; i++) {
                let text = characters[Math.floor(Math.random() * characters.length)];
                
                ctx.fillText(text, i * font_size, drops[i] * font_size);
                
                if (drops[i] * font_size > H && Math.random() > 0.975) {
                    drops[i] = 0; 
                }
                drops[i]++;
            }
        }
        
        window.onresize = function() {
            W = canvas.width = window.innerWidth;
            H = canvas.height = window.innerHeight;
            columns = Math.floor(W / font_size);
            drops = [];
            for(let x=0; x<columns; x++) drops[x] = 1;
        }

        setInterval(draw, 33); 

        // æ›¿æ¢ä¸ºæ‚¨çš„ Render éƒ¨ç½²åœ°å€
        const API_BASE_URL = "https://cybersecurity-info-research.onrender.com/api/search"; 

        // --- è¿›åº¦æ¡æ§åˆ¶ ---
        let intervalId;

        function startProgressBar(attempt = 1) {
            const progressBar = document.getElementById('progress-bar');
            const progressContainer = document.getElementById('progress-container');
            
            progressContainer.style.display = 'block';
            progressBar.style.width = '0%';
            let width = 0;

            if (attempt > 1) {
                 document.getElementById('loading').innerHTML = `æœåŠ¡æ­£åœ¨å¯åŠ¨ï¼Œå°è¯•ç¬¬ ${attempt} æ¬¡é‡è¯•...`;
            } else {
                 document.getElementById('loading').innerHTML = `æ­£åœ¨è¿›è¡Œæ·±åº¦å®‰å…¨ä¿¡æ¯æ£€ç´¢...`;
            }

            intervalId = setInterval(() => {
                // æ¨¡æ‹Ÿè¿›åº¦å¢é•¿ï¼Œåˆ°95%åå‡ç¼“
                if (width < 95) {
                    width += 1; 
                } else if (width < 99) {
                    width += 0.2; 
                } else {
                    clearInterval(intervalId); 
                }
                progressBar.style.width = width + '%';
            }, 100); 
        }

        function stopProgressBar(success = true) {
            clearInterval(intervalId);
            const progressBar = document.getElementById('progress-bar');
            const progressContainer = document.getElementById('progress-container');
            
            if (success) {
                progressBar.style.width = '100%';
            } else {
                progressBar.style.width = '0%';
            }
            // ç¨åéšè—å®¹å™¨
            setTimeout(() => {
                progressContainer.style.display = 'none';
            }, 500); 
        }
        
        // --- æ ¸å¿ƒæœç´¢é€»è¾‘ - å¢åŠ é‡è¯•æœºåˆ¶ ---
        async function searchCompany() {
            const companyName = document.getElementById('companyName').value.trim();
            const companyUrl = document.getElementById('companyUrl').value.trim(); 

            if (!companyName) {
                alert("è¯·è¾“å…¥å…¬å¸åç§°");
                return;
            }

            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';
            
            // è°ƒç”¨é‡è¯•å‡½æ•°
            await fetchWithRetry(companyName, companyUrl, 1);
        }

        async function fetchWithRetry(companyName, companyUrl, attempt) {
            const resultsDiv = document.getElementById('results');
            const loadingDiv = document.getElementById('loading');
            
            loadingDiv.style.display = 'block';
            startProgressBar(attempt); // å¯åŠ¨è¿›åº¦æ¡ï¼Œå¹¶æ˜¾ç¤ºå°è¯•æ¬¡æ•°

            try {
                let url = `${API_BASE_URL}?name=${encodeURIComponent(companyName)}`;
                if (companyUrl) {
                    url += `&url=${encodeURIComponent(companyUrl)}`; 
                }
                
                const response = await fetch(url);
                
                // æ£€æŸ¥ HTTP çŠ¶æ€ç æ˜¯å¦æ˜¯ 5xx (Render é”™è¯¯é¡µé¢)
                if (response.status >= 500 && response.status < 600) {
                     // æ•è· SERVER_TIMEOUT é”™è¯¯
                     throw new Error("SERVER_TIMEOUT");
                }
                
                // å°è¯•è·å– JSON
                const text = await response.text(); 
                const data = JSON.parse(text); 

                loadingDiv.style.display = 'none';

                if (data.error) {
                    stopProgressBar(false); 
                    resultsDiv.innerHTML = `<div style="color:#FF6347;">æœç´¢å¤±è´¥: ${data.error}</div><div style="font-size:0.8em; color:#FFD700;">${data.details || ''}</div>`;
                } else {
                    stopProgressBar(true); 
                    displayResults(data);
                }
            } catch (e) {
                // å¦‚æœæ˜¯é¦–æ¬¡é”™è¯¯ (Failed to fetch æˆ– JSON è§£æé”™è¯¯/è¶…æ—¶)ï¼Œå¹¶ä¸”ä¸æ˜¯ç¬¬äºŒæ¬¡å°è¯•
                if (attempt < 2 && (e.message.includes("Failed to fetch") || e.message.includes("JSON") || e.message.includes("SERVER_TIMEOUT"))) {
                    
                    // ç­‰å¾… 10 ç§’ï¼Œç»™ Render æ›´å……è¶³çš„æ—¶é—´æ¥å”¤é†’å’Œå¯åŠ¨ Gunicorn
                    document.getElementById('loading').innerHTML = `é¦–æ¬¡è¿æ¥å¤±è´¥ï¼ŒæœåŠ¡å¯åŠ¨ä¸­... 10ç§’åé‡è¯•...`;
                    stopProgressBar(false); 
                    
                    // æ ¸å¿ƒä¿®æ”¹ï¼šç­‰å¾…æ—¶é—´æ”¹ä¸º 10000 æ¯«ç§’ (10ç§’)
                    await new Promise(resolve => setTimeout(resolve, 10000));
                    
                    // è¿›è¡Œç¬¬äºŒæ¬¡é‡è¯•
                    await fetchWithRetry(companyName, companyUrl, 2);
                    
                } else {
                    // å¦‚æœæ˜¯ç¬¬äºŒæ¬¡é‡è¯•ä»ç„¶å¤±è´¥ï¼Œæˆ–ä¸æ˜¯æˆ‘ä»¬é¢„æœŸå†…çš„é”™è¯¯
                    loadingDiv.style.display = 'none';
                    stopProgressBar(false); 
                    resultsDiv.innerHTML = `<div style="color:#FF6347;">è¿æ¥é”™è¯¯ (å·²é‡è¯•): æ— æ³•è¿æ¥æˆ–æœåŠ¡å“åº”éç»“æ„åŒ–æ•°æ® (${e.message})</div>`;
                }
            }
        }

        function displayResults(data) {
            const resultsDiv = document.getElementById('results');
            
            resultsDiv.innerHTML = `
                <div class="info-item">
                    <span class="label">å…¬å¸åç§°:</span>
                    <span class="content">${data.company_name || 'æœªæ‰¾åˆ°'}</span>
                </div>
                <div class="info-item">
                    <span class="label">å®˜æ–¹ç½‘ç«™:</span> 
                    <span class="content">${data.website && data.website !== 'ä¿¡æ¯ä¸è¶³ï¼Œæ— æ³•ç¡®è®¤ã€‚' ? `<a href="http://${data.website}" target="_blank">${data.website}</a>` : data.website || 'æœªæ‰¾åˆ°'}</span>
                </div>
                <div class="info-item">
                    <span class="label">å¹´åº¦è¥æ”¶:</span> 
                    <span class="content">${data.revenue || 'æœªæ‰¾åˆ°'}</span>
                </div>
                <div class="info-item">
                    <span class="label">ä¸šåŠ¡èŒƒå›´:</span> 
                    <span class="content">${data.business || 'æœªæ‰¾åˆ°'}</span>
                </div>
                <div class="info-item">
                    <span class="label">å®‰å…¨äº‹ä»¶:</span> 
                    <span class="content">${data.security_incident || 'æœªæ‰¾åˆ°'}</span>
                </div>
            `;
        }
    </script>
</body>
</html>
